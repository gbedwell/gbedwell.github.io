---
title: 'The 2023 ECF, the 3 point shot, and under/overperformance'
excerpt: 'Analyzing 3 point shooting percentage in the 2023 ECF.'
classes: wide
output:
  md_document:
    variant: gfm
    preserve_yaml: true
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = paste0(
        '/Users/gbedwell/Documents/github/gbedwell.github.io/_posts/', '2023-06-12', '-', 'ecf-three','.md'
      ),
      envir = globalenv()
    )
  })
---

```{r, include=FALSE}
date <- "2023-06-12"

base.dir <- "/Users/gbedwell/Documents/github/gbedwell.github.io/"
base.url <- "/"
dir.create(paste0("../figures/", date))
fig.path <- paste0("../figures/", date, "/")

knitr::opts_chunk$set(
  fig.asp = 5/7,
  fig.width = 7,
  dpi = 300,
  fig.align = "center",
  out.width = "80%",
  comment = "#>",
  collapse = TRUE,
  dev = "png",
  base.dir = base.dir, 
  base.url = base.url,
  fig.path = fig.path
  )
```

### Introduction
The 2022-2023 NBA season is over. The Denver Nuggets, this season's Western Conference champions and Finals favorites, defeated the never-say-die Miami Heat in the Finals 4 games to 1. The Nuggets, led by the virtually unstoppable Nikola Jok√≠c (who <i>averaged</i> 30-13.5-9.5 per game across these playoffs), made relatively easy work of the 8-seed Heat. Nevertheless, the Heat's impressive, and at times utterly dominant, run through both the 1-seed Milwaukee Bucks (4-1) and the 2-seed Boston Celtics (4-3) has already had [significant consequences](https://www.nba.com/bucks/news/milwaukee-bucks-part-ways-with-head-coach-mike-budenholzer) and could yet have more.

In the Eastern Conference Finals (ECF) against the Celtics, the Heat overturned double-digit deficits in the second halves of both Games 1 and 2 and went on to win them both. Game 3 was an emphatic 128-102 Heat victory. The Celtics won the next 3 games, evening the series at three games apiece and forcing a deciding Game 7 back in Boston. In this winner-take-all showdown, the Heat absolutely embarrassed the home team with a 103-84 victory. Much has been said about how this ECF played out. Most of this commentary can be succinctly summarized: the Heat have "that dawg in 'em", and the Celtics simply do not. It's hard not to be at least a little sympathetic to this argument. Another, more tangible, aspect of the series, however, was the apparent difference in 3 point shooting percentage (3P%) between the Heat and the Celtics. Per [basketball-reference](https://www.basketball-reference.com/leagues/NBA_2023.html), the Celtics rode the three point shot to 57 wins over the 2022-2023 NBA season, shooting 42.6 threes per game (2nd overall) with a season average 37.7% success rate (6th overall). The Heat, on the other hand, shot 34.8 threes per game (10th overall) with a measly 34.4% success rate (27th overall). During the [ECF](https://www.basketball-reference.com/playoffs/2023-nba-eastern-conference-finals-heat-vs-celtics.html), however, the Heat shot 43.4% from behind the arc, while the Celtics shot just 30.3% -- a staggering reversal. Notably, Celtics stars Jayson Tatum and Jaylen Brown went a combined 18/90 (20%) from downtown, while Heat role players Caleb Martin, Gabe Vincent, and Duncan Robinson went 53/107 (49.5%). It was, in other words, a perfect storm of sustained underperformance from players on one team paired with sustained overperformance from players on the other. Exactly how bad was the Celtics' 3P% in the ECF relative to their regular season numbers? How good was the Heat's? 

My general approach to answering these questions is as follows:

1. Collect league-wide data for the 2019-2023 regular seasons.
2. Use this collated data to approximate the "true" 3P% for the 2022-2023 Miami Heat and Boston Celtics
2. Re-scale the season-long 3P% distributions to the ECF.
3. Calculate the probabilities of observing the actual ECF 3P% from the adjusted 3P% data.

In an attempt to avoid clutter, I will leave a lot of the nitty gritty details out of this published post. You can, however, find the entire .Rmd file with (hopefully) helpful comments [here](https://github.com/gbedwell/gbedwell.github.io/blob/master/_R/ecf-three.Rmd).

All of the data used in this post was retrieved from the fantastic [basketball-reference.com](https://www.basketball-reference.com/) using [rvest](https://cran.r-project.org/web/packages/rvest/index.html). 

```{r, echo = FALSE}
# Load packages
pkgs <- c( "gamlss", "rvest", "dplyr", "tibble", "tidyr", "ggplot2", "broom.mixed", "ggpointdensity")

invisible( 
  sapply( X = pkgs,
          FUN = function(x){
            suppressPackageStartupMessages(
              library( x, quietly = TRUE, character.only = TRUE )
              )
            }
          )
  )
```

```{r, echo = FALSE}
# Get regular season data for the past 5 seasons.
season <- lapply( X = as.list( c( 2019, paste0( "202", 0:3 ) ) ),
                  FUN = function(x){
                    url <- paste0( "https://www.basketball-reference.com/leagues/NBA_", 
                                   x, "_totals.html" )
                    page <- rvest::read_html( url )
                    
                    cols <- page %>% 
                      rvest::html_nodes("table#totals_stats > thead > tr > th") %>%
                      rvest::html_text()
                    
                    cols <- cols[ -c(1) ]
                    
                    dat <- data.frame( 
                      t( matrix( data = page %>% 
                                   rvest::html_nodes("table#totals_stats > tbody > tr > td") %>%
                                   rvest::html_text(),
                                 nrow = 29 )
                         ) 
                      )
                    colnames( dat ) <- cols
                    
                    dat <- dat |>
                      dplyr::mutate( dplyr::across( c( 3, 5:29 ), as.numeric ) ) |>
                      tibble::add_column( Season = as.numeric( x ), .after = 3 ) |>
                      dplyr::filter( Tm != "TOT" )
                    }
                  )

season <- do.call( rbind, season )

# Extract season 3P data
# Filter for players who played at least 25 games with a single team.
season.three <- season |>
  dplyr::select( Player, Season, Tm, G, `3P`, `3PA`, `3P%` ) |>
  tidyr::drop_na() |>
  magrittr::set_colnames( c( "player", "season", "team", "games", "made", "attempts", "perc" ) ) |>
  dplyr::filter( games >= 25 )
```

```{r, echo = FALSE}
# Get 2023 ECF data
ecf.url <- "https://www.basketball-reference.com/playoffs/2023-nba-eastern-conference-finals-heat-vs-celtics.html"
ecf.page <- read_html( ecf.url )

ecf <- lapply( X = as.list( c( "MIA", "BOS") ),
               FUN = function(x){
                 cols <- ecf.page %>%
                   rvest::html_nodes( paste0( "table#", x, " > thead > tr > th") ) %>%
                   rvest::html_text()
                 cols <- cols[ -c( 1:5 ) ]
                
                 dat <- data.frame( 
                   t( matrix( data = ecf.page %>% 
                                rvest::html_nodes( paste0( "table#", x, " > tbody > tr > td" ) ) %>%
                                rvest::html_text(),
                              nrow = 29 )
                      )
                   )
                 colnames( dat ) <- cols
                
                 dat <- dat[ , 1:20 ]
                
                 dat <- dat |>
                   dplyr::mutate( dplyr::across( 2:20, as.numeric ) ) |>
                   tibble::add_column( Season = 2023, .after = 1 ) |>
                   tibble::add_column( Tm = x, .after = 2 )
                 }
               )

# Get ECF 3P data
ecf.three <- do.call( rbind, ecf ) |>
  dplyr::select( Player, Tm, `3P`, `3PA` ) |>
  dplyr::mutate( `3P%` = `3P` / `3PA` ) |>
  tidyr::drop_na() |>
  magrittr::set_colnames( c( "player", "team", "ecf.made", "ecf.attempts", "ecf.perc" ) )
```

```{r, echo = FALSE, include = FALSE}
# Do beta-binomial regression to eliminate 3PA as a confounding variable to 3P%
# The logic is simple: better shooters likely to take more shots.

fit <- gamlss( cbind( made, attempts - made ) ~ log( attempts ) ,
               data = season.three,
               family = gamlss.dist::BB( mu.link = "logit", sigma.link = "log" ) )

# summary( fit )
# plot( fit )
```

```{r, echo = FALSE}
# Apply regression parameters to player data
# Estimate "true" season-specific 3P%
season.three <- season.three |>
  dplyr::mutate( mu = fitted( object = fit, what = "mu" ),
                 sigma = fitted( object = fit, what = "sigma" ),
                 prior.alpha = mu / sigma,
                 prior.beta = (1 - mu) / sigma,
                 season.alpha  = prior.alpha + made,
                 season.beta =  prior.beta + attempts - made,
                 season.mean = season.alpha / ( season.alpha + season.beta ) )

# Name players of interest (poi)
# All players who to at least 15 3PA during the ECF
poi <- ecf.three[ ecf.three$ecf.attempts >= 15, ]$player

poi.df <- season.three |> 
  dplyr::filter( player %in% poi, season == 2023 ) |>
  dplyr::arrange( team, player ) |>
  dplyr::select( player, team, games, attempts, season.alpha, season.beta, season.mean ) |>
  dplyr::mutate( season.low  = qbeta( 0.025, shape1 = season.alpha, shape2 = season.beta ),
                 season.high = qbeta( 0.975, shape1 = season.alpha, shape2 = season.beta ) )
  # tidyr::crossing( x = seq( 0.32, 0.42, 0.0001 ) ) |>
  # dplyr::mutate( density = dbeta(x, shape1 = season.alpha, shape2 = season.beta ) )
```

### 2022-2023 Regular Season 3P%

Statistically speaking, every shot that a player takes is a [Bernoulli random variable](https://en.wikipedia.org/wiki/Bernoulli_distribution) with some probability of success. Not all shots are the same, however. A 3-point shot taken from center court, for instance, is going to have a lower probability of success than a 3-point shot taken with the shooter's toe just behind the arc. Because of this, the probability of success varies from shot to shot. Over time, however, it is reasonable to assume that the types of shots that a player takes will, on average, be similar to the shots taken by players across the entire league. No player is going to explicitly seek out lower probability shots. Under this assumption, a player's shooting percentage can be thought of as the <i>average</i> probability of success that any given shot by the player will result in a basket. A series of shots taken by the player over the course of a game, series, or season, therefore, is a [binomial](https://en.wikipedia.org/wiki/Binomial_distribution) random variable with a probability of success equal to the player's shooting percentage. There is an inherent degree of randomness to shooting, however, and the observed shooting percentage might not be the best estimate of the player's <i>true</i> shooting percentage. To try to correct for this, I used empirical Bayes estimation to obtain better estimates of player's true shooting percentage. See David Robinson's (no, not <i>that</i> David Robinson) [blog posts and book](http://varianceexplained.org/r/empirical-bayes-book/) for a fantastic introduction to empirical Bayes.

Below, I show the 2022-2023 regular season adjusted 3P% for all Celtics and Heat players that took over 15 3PA during the ECF. The players on the y-axis are ranked in descending order by adjusted 3P%. Adjusted 3P% is shown as a colored point for each player. The points are colored according to the team the player played for. The number of 3-point shots taken by the player during the regular season is denoted by the size of the point. The 95% [credible interval](https://en.wikipedia.org/wiki/Credible_interval) is additionally shown for each player.

```{r, echo = FALSE, warning = FALSE}
desc.df <- poi.df |>
  dplyr::arrange( desc( season.mean ) )

desc.df$player <- factor( desc.df$player, levels = rev( desc.df$player ) )

ggplot( desc.df, aes( x = season.mean, y = player, fill = team, size = attempts ) ) +
  geom_errorbarh( aes( xmax = season.high, xmin = season.low ), 
                  linewidth = 0.5, height = 0.3, show.legend = FALSE ) +
  geom_point( shape = 21, color = "black" ) +
  scale_fill_manual("Team",
                    values = c( BOS = "#007A33", MIA = "#98002E" ),
                    labels = c( "Boston", "Miami" ),
                    guide = guide_legend( override.aes = list( size = 4 ),
                                          title.position = "top",
                                          title.hjust = 0.5 ) ) +  
  scale_size_continuous( breaks = c( 200, 400, 600 ) ) +
  guides( size = guide_legend( title = "3P Attempts", title.position = "top", title.hjust = 0.5 ) ) +
  theme_bw() +
  theme( legend.position="top",
         legend.text = element_text(size=12),
         legend.justification="center",
         legend.title = element_text( size = 12 ),
         axis.text = element_text( size = 14 ),
         axis.title = element_text( size = 16) ) +
  labs( x = "Adjusted Season 3P%", y = "" )
```

```{r, echo = FALSE}
# Calculate the probability of observing 5 Celtics ranked in the top 5
# Assuming random sampling from a uniform distribution
# Replace "BOS" and "MIA" with 1 and 0, respectively, to make assessment an easy sum.

vec <- c( rep( 1, 7 ), rep( 0, 6 ) )

perm <- replicate( n = 1E6, expr = sample( x = vec, size = length( vec ), replace = FALSE ), simplify = TRUE )

rank.p <- sum( colSums( perm[ 1:5, ] ) == 5 ) / ncol( perm )
```

```{r, echo = FALSE}
# Permute adjusted 3P% values and calculate the difference in BOS/MIA means.
# Compare it to the observed difference in means.

perm.diff <- sapply( X = 1:1E6,
                     FUN = function(x){
                       perm <- sample( nrow( poi.df ) )
                       dat <- transform( poi.df, season.mean = season.mean[ perm ] )
                       mean( dat$season.mean[ dat$team == "BOS" ] ) - 
                         mean( dat$season.mean[ dat$team == "MIA" ] )
                       }
                     )

real.diff <- mean( poi.df$season.mean[ poi.df$team == "BOS" ] ) - 
  mean( poi.df$season.mean[ poi.df$team == "MIA" ] )

mean.diff.p <- sum( perm.diff >= real.diff ) / length( perm.diff )
```

What immediately stands out is that the 5 highest ranked players are all Celtics. How probable is this assuming that the rankings were randomly generated from a uniform distribution (i.e., that all players have the same 3P%)? Using a brute force approach, I randomly re-sampled the list 1 million times and counted the number of times 5 Celtics players made up the top 5. The answer is just `r round( rank.p * 100, 2 )`% of the time. To assess whether or not these 7 Boston players shot better collectively during the regular season than these 6 Heat players, I used a similar permutation-based approach to determine whether or not the observed difference in the mean adjusted 3P% for each <i>team</i> was equal to zero. I randomly shuffled the adjusted 3P% values across all 13 players 1 million times and quantified the number of times the permuted difference was greater than or equal to the observed difference. This happened just `r round( mean.diff.p * 100, 2 )`% of the time. These data provide strong evidence that these Boston Celtics really were better 3-point shooters than these Miami Heat during the 2022-2023 regular season. Now lets look at what happened during the ECF. 

### 2023 Eastern Conference Final 3P%

I've already mentioned how dramatically the tables seemed to turn with respect to 3-point shooting during the 2023 ECF. I've also highlighted how particular players seemed to under/overperform during the 7-game series relative to their season-long output. What I want to do now is try to determine just how significant that under/overperformance was.

The most convenient way to describe 3P% and its range of possible values is as a [beta](https://en.wikipedia.org/wiki/Beta_distribution) distribution. The beta distribution is described by the shape parameters $\alpha$ and $\beta$, which can be thought of, respectively, as the number of successes and the number of failures in a series of Bernoulli trials. Given the season-long adjusted 3P%, therefore, we can rescale the regular season 3P% distribution to match the number of 3-point attempts each player made during the ECF. This will allow us to better account for the increased variance associated with taking fewer shots during a 7-game playoff series relative to the 82-game regular season.

```{r}
# Marry poi.df with ECF data
poi.df <- dplyr::left_join( poi.df, ecf.three, by = c( "player", "team" ) )

# Rescale regular season distribution to ECF shooting numbers
poi.df <- poi.df |>
  dplyr::mutate( rescale.alpha = season.mean * ecf.attempts,
                 rescale.beta = ecf.attempts - rescale.alpha,
                 rescale.low  = qbeta( 0.025, shape1 = rescale.alpha, shape2 = rescale.beta ),
                 rescale.high  = qbeta( 0.975, shape1 = rescale.alpha, shape2 = rescale.beta ) )
```

The rescaled 3P% data are shown in the plot below. The plot features are the same as the plot above, but with the addition of the observed ECF 3P% for each player. The position of the observed ECF 3P% for each player along the 95% credible interval for the rescaled regular season 3P% provides a quick visual representation of player under/overperformance in the ECF. 

```{r, echo = FALSE}
library( ggnewscale )
desc.df2 <- poi.df |>
  dplyr::arrange( desc( season.mean ) )

desc.df2$player <- factor( desc.df2$player, levels = rev( desc.df2$player ) )

ggplot( desc.df2, aes( x = season.mean, y = player, fill = team, size = ecf.attempts ) ) +
  geom_errorbarh( aes( xmax = rescale.high, xmin = rescale.low ), linewidth = 0.5, height = 0.3, show.legend = FALSE ) +
  geom_point( shape = 21, color = "black" ) +
  scale_fill_manual("Team",
                    values = c( BOS = "#007A33", MIA = "#98002E" ),
                    labels = c( "Boston", "Miami" ),
                    guide = guide_legend( override.aes = list( size = 4 ),
                                          title.position = "top",
                                          title.hjust = 0.5 ) ) + 
  new_scale_fill() + 
  geom_point( aes( x = ecf.perc, y = player, fill = "gray75" ), size = 3, shape = 23, color = "black" ) +
  scale_fill_manual("ECF",
                    values = c( "gray75" ),
                    labels = c( "Observed" ),
                    guide = guide_legend( override.aes = list( size = 3 ),
                                          title.position = "top",
                                          title.hjust = 0.5 ) ) +   
  scale_size_continuous( breaks = c( 20, 30, 40 ) ) +
  guides( size = guide_legend( title = "3P Attempts", title.position = "top", title.hjust = 0.5 ) ) +
  theme_bw() +
  theme( legend.position="top",
         legend.text = element_text(size=12),
         legend.justification="center",
         legend.title = element_text( size = 12 ),
         axis.text = element_text( size = 14 ),
         axis.title = element_text( size = 16) ) +
  labs( x = "Adjusted Season 3P%", y = "" )
```
The 95% credible interval defines the range that contains 95% of the probable values for a given player's 3P%. This doesn't mean that a player cannot have a 3P% outside of that range. It just means that there is a less than 5% chance that the player will. 

```{r}
credint <- function( x, y, z ){
  tmp <- pbeta( q = as.numeric( x ), 
                shape1 = as.numeric( y ), 
                shape2 = as.numeric( z ) ) }

poi.df <- poi.df |>
  dplyr::rowwise() |>
  dplyr::mutate( prob.season.better = credint( ecf.perc, rescale.alpha, rescale.beta ) ) |>
  dplyr::ungroup()
```















